{% extends 'base_modern.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans 'Categorías Financieras' %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<style>
    .category-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .category-type-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }
    .color-preview {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">{% trans 'Gestión de Categorías' %}</h1>
            <p class="text-muted">{% trans 'Administra las categorías para gastos, ingresos e inversiones' %}</p>
        </div>
        <div>
            <a href="{% url 'financial:category_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> {% trans 'Nueva Categoría' %}
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                {% trans 'Categorías de Gastos' %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ expense_categories_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-cash-stack fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                {% trans 'Categorías de Ingresos' %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ income_categories_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-cash-coin fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                {% trans 'Categorías de Inversiones' %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ investment_categories_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                {% trans 'Total Categorías' %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ total_categories_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-tags fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <ul class="nav nav-tabs card-header-tabs" id="categoryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" 
                            type="button" role="tab">
                        {% trans 'Todas' %} ({{ total_categories_count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" 
                            type="button" role="tab">
                        {% trans 'Gastos' %} ({{ expense_categories_count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="income-tab" data-bs-toggle="tab" data-bs-target="#income" 
                            type="button" role="tab">
                        {% trans 'Ingresos' %} ({{ income_categories_count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="investments-tab" data-bs-toggle="tab" data-bs-target="#investments" 
                            type="button" role="tab">
                        {% trans 'Inversiones' %} ({{ investment_categories_count }})
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="categoryTabsContent">
                <!-- All Categories -->
                <div class="tab-pane fade show active" id="all" role="tabpanel">
                    <div class="row">
                        {% for category in categories %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card category-card h-100" style="border-left-color: {{ category.color }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">{{ category.name }}</h6>
                                            <span class="badge 
                                                {% if category.category_type == 'expense' %}bg-danger
                                                {% elif category.category_type == 'income' %}bg-success
                                                {% else %}bg-info{% endif %} 
                                                category-type-badge">
                                                {{ category.get_category_type_display }}
                                            </span>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                    data-bs-toggle="dropdown">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{% url 'financial:category_update' category.id %}">
                                                    <i class="bi bi-pencil"></i> {% trans 'Editar' %}
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" 
                                                       onclick="confirmDelete('{{ category.id }}', '{{ category.name }}')">
                                                    <i class="bi bi-trash"></i> {% trans 'Eliminar' %}
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    {% if category.description %}
                                    <p class="card-text text-muted small">{{ category.description }}</p>
                                    {% endif %}
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="color-preview" style="background-color: {{ category.color }}"></span>
                                            <small class="text-muted">{{ category.color }}</small>
                                        </div>
                                        <div>
                                            {% if category.is_active %}
                                                <span class="badge bg-success">{% trans 'Activa' %}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{% trans 'Inactiva' %}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <small class="text-muted">
                                        {% trans 'Creada el' %} {{ category.created_at|date:"d/m/Y" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-tags fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">{% trans 'No hay categorías registradas' %}</h5>
                            <p class="text-muted">{% trans 'Comienza agregando la primera categoría' %}</p>
                            <a href="{% url 'financial:category_create' %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> {% trans 'Agregar Categoría' %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Expense Categories -->
                <div class="tab-pane fade" id="expenses" role="tabpanel">
                    <div class="row">
                        {% for category in expense_categories %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card category-card h-100" style="border-left-color: {{ category.color }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">{{ category.name }}</h6>
                                            <span class="badge bg-danger category-type-badge">
                                                {% trans 'Gasto' %}
                                            </span>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                    data-bs-toggle="dropdown">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{% url 'financial:category_update' category.id %}">
                                                    <i class="bi bi-pencil"></i> {% trans 'Editar' %}
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" 
                                                       onclick="confirmDelete('{{ category.id }}', '{{ category.name }}')">
                                                    <i class="bi bi-trash"></i> {% trans 'Eliminar' %}
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    {% if category.description %}
                                    <p class="card-text text-muted small">{{ category.description }}</p>
                                    {% endif %}
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="color-preview" style="background-color: {{ category.color }}"></span>
                                            <small class="text-muted">{{ category.color }}</small>
                                        </div>
                                        <div>
                                            {% if category.is_active %}
                                                <span class="badge bg-success">{% trans 'Activa' %}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{% trans 'Inactiva' %}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <small class="text-muted">
                                        {% trans 'Creada el' %} {{ category.created_at|date:"d/m/Y" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-tags fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">{% trans 'No hay categorías de gastos' %}</h5>
                            <p class="text-muted">{% trans 'Agrega categorías para organizar mejor los gastos' %}</p>
                            <a href="{% url 'financial:category_create' %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> {% trans 'Agregar Categoría' %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Income Categories -->
                <div class="tab-pane fade" id="income" role="tabpanel">
                    <div class="row">
                        {% for category in income_categories %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card category-card h-100" style="border-left-color: {{ category.color }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">{{ category.name }}</h6>
                                            <span class="badge bg-success category-type-badge">
                                                {% trans 'Ingreso' %}
                                            </span>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                    data-bs-toggle="dropdown">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{% url 'financial:category_update' category.id %}">
                                                    <i class="bi bi-pencil"></i> {% trans 'Editar' %}
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" 
                                                       onclick="confirmDelete('{{ category.id }}', '{{ category.name }}')">
                                                    <i class="bi bi-trash"></i> {% trans 'Eliminar' %}
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    {% if category.description %}
                                    <p class="card-text text-muted small">{{ category.description }}</p>
                                    {% endif %}
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="color-preview" style="background-color: {{ category.color }}"></span>
                                            <small class="text-muted">{{ category.color }}</small>
                                        </div>
                                        <div>
                                            {% if category.is_active %}
                                                <span class="badge bg-success">{% trans 'Activa' %}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{% trans 'Inactiva' %}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <small class="text-muted">
                                        {% trans 'Creada el' %} {{ category.created_at|date:"d/m/Y" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-tags fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">{% trans 'No hay categorías de ingresos' %}</h5>
                            <p class="text-muted">{% trans 'Agrega categorías para organizar mejor los ingresos' %}</p>
                            <a href="{% url 'financial:category_create' %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> {% trans 'Agregar Categoría' %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Investment Categories -->
                <div class="tab-pane fade" id="investments" role="tabpanel">
                    <div class="row">
                        {% for category in investment_categories %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card category-card h-100" style="border-left-color: {{ category.color }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">{{ category.name }}</h6>
                                            <span class="badge bg-info category-type-badge">
                                                {% trans 'Inversión' %}
                                            </span>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                    data-bs-toggle="dropdown">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{% url 'financial:category_update' category.id %}">
                                                    <i class="bi bi-pencil"></i> {% trans 'Editar' %}
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" 
                                                       onclick="confirmDelete('{{ category.id }}', '{{ category.name }}')">
                                                    <i class="bi bi-trash"></i> {% trans 'Eliminar' %}
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    {% if category.description %}
                                    <p class="card-text text-muted small">{{ category.description }}</p>
                                    {% endif %}
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="color-preview" style="background-color: {{ category.color }}"></span>
                                            <small class="text-muted">{{ category.color }}</small>
                                        </div>
                                        <div>
                                            {% if category.is_active %}
                                                <span class="badge bg-success">{% trans 'Activa' %}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{% trans 'Inactiva' %}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <small class="text-muted">
                                        {% trans 'Creada el' %} {{ category.created_at|date:"d/m/Y" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-tags fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">{% trans 'No hay categorías de inversiones' %}</h5>
                            <p class="text-muted">{% trans 'Agrega categorías para organizar mejor las inversiones' %}</p>
                            <a href="{% url 'financial:category_create' %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> {% trans 'Agregar Categoría' %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans 'Confirmar Eliminación' %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{% trans '¿Estás seguro de que quieres eliminar la categoría' %} "<strong id="categoryName"></strong>"?</p>
                <p class="text-danger">{% trans 'Esta acción no se puede deshacer y puede afectar registros existentes.' %}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancelar' %}</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">{% trans 'Eliminar' %}</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete(categoryId, categoryName) {
    document.getElementById('categoryName').textContent = categoryName;
    document.getElementById('deleteForm').action = `/financial/categories/${categoryId}/delete/`;
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}
</script>
{% endblock %} 
