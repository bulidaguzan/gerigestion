{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Password Change Required - Geriatric Administration System{% endblock %}

{% block extra_css %}
<style>
    .password-change-container {
        max-width: 500px;
        margin: 50px auto;
        padding: 30px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .password-change-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .password-change-header .fa {
        font-size: 48px;
        color: #ffc107;
        margin-bottom: 15px;
    }
    
    .password-change-header h2 {
        color: #333;
        margin-bottom: 10px;
    }
    
    .alert-warning {
        border-left: 4px solid #ffc107;
    }
    
    .password-requirements {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 20px;
        margin: 20px 0;
        font-size: 14px;
    }
    
    .password-requirements h6 {
        color: #495057;
        margin-bottom: 15px;
    }
    
    .password-requirements ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .password-requirements li {
        margin-bottom: 5px;
        color: #6c757d;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .btn-change-password {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        font-weight: 500;
    }
    
    .password-strength {
        margin-top: 5px;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
    }
    
    .password-strength-bar {
        height: 100%;
        transition: width 0.3s ease, background-color 0.3s ease;
        width: 0%;
        background: #dc3545;
    }
    
    .password-strength-bar.weak { background: #dc3545; }
    .password-strength-bar.fair { background: #ffc107; }
    .password-strength-bar.good { background: #fd7e14; }
    .password-strength-bar.strong { background: #28a745; }
    
    .password-strength-text {
        font-size: 12px;
        margin-top: 2px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="password-change-container">
        <div class="password-change-header">
            <i class="fa fa-key"></i>
            <h2>Password Change Required</h2>
            <p class="text-muted">Your password has expired and must be changed</p>
        </div>
        
        <div class="alert alert-warning" role="alert">
            <i class="fa fa-exclamation-triangle me-2"></i>
            <strong>Security Notice:</strong> Your password has expired or needs to be changed for security reasons. You must create a new password to continue.
        </div>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        <div class="password-requirements">
            <h6><i class="fa fa-shield-alt me-2"></i>Password Requirements</h6>
            <ul>
                <li>At least 12 characters long</li>
                <li>Contains uppercase and lowercase letters</li>
                <li>Contains at least one number</li>
                <li>Contains at least one special character (!@#$%^&*)</li>
                <li>Cannot contain common words or patterns</li>
                <li>Cannot contain your personal information</li>
            </ul>
        </div>
        
        <form method="post" novalidate>
            {% csrf_token %}
            
            <div class="form-group">
                <label for="{{ form.old_password.id_for_label }}" class="form-label">
                    Current Password
                </label>
                {{ form.old_password }}
                {% if form.old_password.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.old_password.errors.0 }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                    New Password
                </label>
                {{ form.new_password1 }}
                <div class="password-strength">
                    <div class="password-strength-bar" id="strengthBar"></div>
                </div>
                <div class="password-strength-text" id="strengthText"></div>
                {% if form.new_password1.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.new_password1.errors.0 }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                    Confirm New Password
                </label>
                {{ form.new_password2 }}
                {% if form.new_password2.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.new_password2.errors.0 }}
                    </div>
                {% endif %}
            </div>
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            
            <button type="submit" class="btn btn-primary btn-change-password">
                <i class="fa fa-key me-2"></i>
                Change Password
            </button>
        </form>
        
        <div class="text-center mt-4">
            <small class="text-muted">
                <i class="fa fa-info-circle me-1"></i>
                Need help? Contact your system administrator.
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordField = document.getElementById('{{ form.new_password1.id_for_label }}');
    const confirmPasswordField = document.getElementById('{{ form.new_password2.id_for_label }}');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    
    // Password strength checker
    function checkPasswordStrength(password) {
        let score = 0;
        let feedback = [];
        
        // Length check
        if (password.length >= 12) score += 2;
        else if (password.length >= 8) score += 1;
        else feedback.push('Too short');
        
        // Character variety checks
        if (/[a-z]/.test(password)) score += 1;
        else feedback.push('Add lowercase letters');
        
        if (/[A-Z]/.test(password)) score += 1;
        else feedback.push('Add uppercase letters');
        
        if (/\d/.test(password)) score += 1;
        else feedback.push('Add numbers');
        
        if (/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) score += 1;
        else feedback.push('Add special characters');
        
        // Penalty for common patterns
        if (/(.)\1{2,}/.test(password)) score -= 1; // Repeated characters
        if (/123|abc|qwe/i.test(password)) score -= 1; // Sequential
        if (/password|admin|login/i.test(password)) score -= 2; // Common words
        
        return { score: Math.max(0, score), feedback };
    }
    
    function updateStrengthIndicator(password) {
        const result = checkPasswordStrength(password);
        const score = result.score;
        
        let width, className, text;
        
        if (score <= 2) {
            width = '25%';
            className = 'weak';
            text = 'Weak';
        } else if (score <= 4) {
            width = '50%';
            className = 'fair';
            text = 'Fair';
        } else if (score <= 6) {
            width = '75%';
            className = 'good';
            text = 'Good';
        } else {
            width = '100%';
            className = 'strong';
            text = 'Strong';
        }
        
        strengthBar.style.width = width;
        strengthBar.className = `password-strength-bar ${className}`;
        strengthText.textContent = text;
        
        if (result.feedback.length > 0 && password.length > 0) {
            strengthText.textContent += ` - ${result.feedback.join(', ')}`;
        }
    }
    
    // Real-time password strength checking
    newPasswordField.addEventListener('input', function() {
        updateStrengthIndicator(this.value);
    });
    
    // Password confirmation validation
    function validatePasswordMatch() {
        const password = newPasswordField.value;
        const confirm = confirmPasswordField.value;
        
        if (confirm && password !== confirm) {
            confirmPasswordField.classList.add('is-invalid');
            confirmPasswordField.classList.remove('is-valid');
        } else if (confirm) {
            confirmPasswordField.classList.remove('is-invalid');
            confirmPasswordField.classList.add('is-valid');
        }
    }
    
    confirmPasswordField.addEventListener('input', validatePasswordMatch);
    newPasswordField.addEventListener('input', validatePasswordMatch);
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const password = newPasswordField.value;
        const confirm = confirmPasswordField.value;
        
        if (password !== confirm) {
            e.preventDefault();
            confirmPasswordField.classList.add('is-invalid');
            alert('Passwords do not match. Please try again.');
            return false;
        }
        
        const strength = checkPasswordStrength(password);
        if (strength.score < 4) {
            e.preventDefault();
            alert('Password is too weak. Please choose a stronger password.');
            return false;
        }
    });
    
    // Focus on first field
    document.getElementById('{{ form.old_password.id_for_label }}').focus();
});
</script>
{% endblock %}